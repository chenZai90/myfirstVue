<template>
  <div class="watchers-demo">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
      <h1>ğŸ‘ï¸ ä¾¦å¬å™¨</h1>
      <p class="page-description">
        å­¦ä¹ Vue 3çš„ä¾¦å¬å™¨ï¼ˆwatchï¼‰ï¼Œäº†è§£å¦‚ä½•å“åº”æ•°æ®å˜åŒ–ï¼ŒæŒæ¡watchã€watchEffectçš„ç”¨æ³•å’ŒåŒºåˆ«
      </p>
    </div>

    <!-- åŸºç¡€ä¾¦å¬å™¨ -->
    <section class="demo-section">
      <h2>ğŸ¯ åŸºç¡€ä¾¦å¬å™¨</h2>
      
      <CommentBox
        title="watch() åŸºç¡€ç”¨æ³•"
        description="ä¾¦å¬å™¨ç”¨äºåœ¨å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œï¼Œå¦‚APIè°ƒç”¨ã€DOMæ“ä½œç­‰ã€‚"
        :concepts="[
          { name: 'watch', description: 'ä¾¦å¬ä¸€ä¸ªæˆ–å¤šä¸ªå“åº”å¼æ•°æ®æºï¼Œåœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå›è°ƒ' },
          { name: 'æ•°æ®æº', description: 'refã€reactiveå¯¹è±¡ã€getterå‡½æ•°æˆ–æ•°ç»„' },
          { name: 'å›è°ƒå‡½æ•°', description: 'æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œçš„å‡½æ•°ï¼Œæ¥æ”¶æ–°å€¼å’Œæ—§å€¼' },
          { name: 'å‰¯ä½œç”¨', description: 'æ•°æ®å˜åŒ–æ—¶éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ—¥å¿—è®°å½•ç­‰' }
        ]"
        :code-explanation="basicWatchCodeExplanation"
        :notes="[
          'ä¾¦å¬å™¨é»˜è®¤æ˜¯æ‡’æ‰§è¡Œçš„ï¼Œåªæœ‰æ•°æ®å˜åŒ–æ—¶æ‰æ‰§è¡Œ',
          'å¯ä»¥ä¾¦å¬refã€reactiveã€getterå‡½æ•°ç­‰å¤šç§æ•°æ®æº',
          'å›è°ƒå‡½æ•°æ¥æ”¶æ–°å€¼ã€æ—§å€¼å’Œæ¸…ç†å‡½æ•°ä½œä¸ºå‚æ•°'
        ]"
        :links="[
          { title: 'Vue 3å®˜æ–¹æ–‡æ¡£ - ä¾¦å¬å™¨', url: 'https://cn.vuejs.org/guide/essentials/watchers.html' }
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="BasicWatchDemo" title="åŸºç¡€ä¾¦å¬å™¨ç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="basicWatchCode"
        language="javascript"
        title="åŸºç¡€ä¾¦å¬å™¨ä»£ç "
      />
    </section>

    <!-- ä¾¦å¬æ•°æ®æºç±»å‹ -->
    <section class="demo-section">
      <h2>ğŸ“Š ä¾¦å¬æ•°æ®æºç±»å‹</h2>
      
      <CommentBox
        title="ä¸åŒæ•°æ®æºçš„ä¾¦å¬æ–¹å¼"
        description="watchå¯ä»¥ä¾¦å¬ä¸åŒç±»å‹çš„æ•°æ®æºï¼ŒåŒ…æ‹¬refã€reactiveå¯¹è±¡ã€getterå‡½æ•°å’Œæ•°ç»„ã€‚"
        :concepts="[
          { name: 'refä¾¦å¬', description: 'ç›´æ¥ä¾¦å¬refå¯¹è±¡' },
          { name: 'reactiveä¾¦å¬', description: 'ä¾¦å¬reactiveå¯¹è±¡çš„å±æ€§' },
          { name: 'getterä¾¦å¬', description: 'ä½¿ç”¨å‡½æ•°è¿”å›è¦ä¾¦å¬çš„å€¼' },
          { name: 'å¤šæºä¾¦å¬', description: 'åŒæ—¶ä¾¦å¬å¤šä¸ªæ•°æ®æº' }
        ]"
        :code-explanation="watchSourcesCodeExplanation"
        :notes="[
          'reactiveå¯¹è±¡éœ€è¦ä½¿ç”¨getterå‡½æ•°æ¥ä¾¦å¬ç‰¹å®šå±æ€§',
          'ä¾¦å¬æ•´ä¸ªreactiveå¯¹è±¡ä¼šæ·±åº¦ä¾¦å¬æ‰€æœ‰å±æ€§',
          'å¤šæºä¾¦å¬çš„å›è°ƒæ¥æ”¶æ•°ç»„å½¢å¼çš„æ–°å€¼å’Œæ—§å€¼'
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="WatchSourcesDemo" title="ä¾¦å¬æ•°æ®æºç±»å‹ç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="watchSourcesCode"
        language="javascript"
        title="ä¾¦å¬æ•°æ®æºç±»å‹ä»£ç "
      />
    </section>

    <!-- æ·±åº¦ä¾¦å¬ -->
    <section class="demo-section">
      <h2>ğŸ” æ·±åº¦ä¾¦å¬</h2>
      
      <CommentBox
        title="æ·±åº¦ä¾¦å¬è¯¦è§£"
        description="æ·±åº¦ä¾¦å¬å¯ä»¥æ£€æµ‹åµŒå¥—å¯¹è±¡å†…éƒ¨å€¼çš„å˜åŒ–ï¼Œé€‚ç”¨äºå¤æ‚æ•°æ®ç»“æ„çš„ç›‘æ§ã€‚"
        :concepts="[
          { name: 'deepé€‰é¡¹', description: 'å¯ç”¨æ·±åº¦ä¾¦å¬ï¼Œæ£€æµ‹åµŒå¥—å±æ€§å˜åŒ–' },
          { name: 'æ€§èƒ½è€ƒè™‘', description: 'æ·±åº¦ä¾¦å¬ä¼šéå†æ‰€æœ‰åµŒå¥—å±æ€§ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§' },
          { name: 'åº”ç”¨åœºæ™¯', description: 'é€‚ç”¨äºå¤æ‚å¯¹è±¡ã€æ•°ç»„ç­‰åµŒå¥—æ•°æ®ç»“æ„' }
        ]"
        :code-explanation="deepWatchCodeExplanation"
        :notes="[
          'æ·±åº¦ä¾¦å¬ä¼šæ£€æµ‹å¯¹è±¡å†…éƒ¨æ‰€æœ‰åµŒå¥—å±æ€§çš„å˜åŒ–',
          'å¯¹äºå¤§å‹å¯¹è±¡ï¼Œæ·±åº¦ä¾¦å¬å¯èƒ½å½±å“æ€§èƒ½',
          'å¯ä»¥é€šè¿‡ä¾¦å¬ç‰¹å®šå±æ€§æ¥é¿å…ä¸å¿…è¦çš„æ·±åº¦ä¾¦å¬'
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="DeepWatchDemo" title="æ·±åº¦ä¾¦å¬ç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="deepWatchCode"
        language="javascript"
        title="æ·±åº¦ä¾¦å¬ä»£ç "
      />
    </section>

    <!-- watchEffect -->
    <section class="demo-section">
      <h2>âš¡ watchEffect</h2>
      
      <CommentBox
        title="watchEffectè¯¦è§£"
        description="watchEffectä¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œå¹¶è‡ªåŠ¨è¿½è¸ªå…¶ä¾èµ–ï¼Œå½“ä¾èµ–å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œã€‚"
        :concepts="[
          { name: 'watchEffect', description: 'ç«‹å³æ‰§è¡Œå¹¶è‡ªåŠ¨è¿½è¸ªä¾èµ–çš„ä¾¦å¬å™¨' },
          { name: 'è‡ªåŠ¨ä¾èµ–è¿½è¸ª', description: 'è‡ªåŠ¨æ”¶é›†å‡½æ•°å†…ä½¿ç”¨çš„å“åº”å¼æ•°æ®ä½œä¸ºä¾èµ–' },
          { name: 'ç«‹å³æ‰§è¡Œ', description: 'åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä¸åƒwatchçš„æ‡’æ‰§è¡Œ' },
          { name: 'æ¸…ç†å‡½æ•°', description: 'å¯ä»¥è¿”å›æ¸…ç†å‡½æ•°ï¼Œåœ¨é‡æ–°æ‰§è¡Œå‰æˆ–ç»„ä»¶å¸è½½æ—¶è°ƒç”¨' }
        ]"
        :code-explanation="watchEffectCodeExplanation"
        :notes="[
          'watchEffectä¼šåœ¨åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡',
          'è‡ªåŠ¨è¿½è¸ªå‡½æ•°å†…ä½¿ç”¨çš„æ‰€æœ‰å“åº”å¼æ•°æ®',
          'é€‚åˆéœ€è¦ç«‹å³æ‰§è¡Œä¸”ä¾èµ–æ˜ç¡®çš„åœºæ™¯'
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="WatchEffectDemo" title="watchEffectç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="watchEffectCode"
        language="javascript"
        title="watchEffectä»£ç "
      />
    </section>

    <!-- ä¾¦å¬å™¨é€‰é¡¹ -->
    <section class="demo-section">
      <h2>âš™ï¸ ä¾¦å¬å™¨é€‰é¡¹</h2>
      
      <CommentBox
        title="ä¾¦å¬å™¨é…ç½®é€‰é¡¹"
        description="ä¾¦å¬å™¨æä¾›å¤šç§é…ç½®é€‰é¡¹æ¥æ§åˆ¶å…¶è¡Œä¸ºï¼Œå¦‚ç«‹å³æ‰§è¡Œã€æ·±åº¦ä¾¦å¬ã€åˆ·æ–°æ—¶æœºç­‰ã€‚"
        :concepts="[
          { name: 'immediate', description: 'ç«‹å³æ‰§è¡Œä¾¦å¬å™¨å›è°ƒ' },
          { name: 'deep', description: 'æ·±åº¦ä¾¦å¬å¯¹è±¡å†…éƒ¨å˜åŒ–' },
          { name: 'flush', description: 'æ§åˆ¶å›è°ƒçš„åˆ·æ–°æ—¶æœº' },
          { name: 'onTrack/onTrigger', description: 'è°ƒè¯•é€‰é¡¹ï¼Œè¿½è¸ªä¾èµ–å˜åŒ–' }
        ]"
        :code-explanation="watchOptionsCodeExplanation"
        :notes="[
          'immediate: true ä½¿ä¾¦å¬å™¨åœ¨åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œ',
          'flushæ§åˆ¶å›è°ƒæ‰§è¡Œæ—¶æœºï¼špre(é»˜è®¤)ã€postã€sync',
          'onTrackå’ŒonTriggerç”¨äºè°ƒè¯•ä¾èµ–è¿½è¸ª'
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="WatchOptionsDemo" title="ä¾¦å¬å™¨é€‰é¡¹ç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="watchOptionsCode"
        language="javascript"
        title="ä¾¦å¬å™¨é€‰é¡¹ä»£ç "
      />
    </section>

    <!-- åœæ­¢ä¾¦å¬å™¨ -->
    <section class="demo-section">
      <h2>ğŸ›‘ åœæ­¢ä¾¦å¬å™¨</h2>
      
      <CommentBox
        title="ä¾¦å¬å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"
        description="äº†è§£å¦‚ä½•æ­£ç¡®åœæ­¢ä¾¦å¬å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œä¸å¿…è¦çš„è®¡ç®—ã€‚"
        :concepts="[
          { name: 'è‡ªåŠ¨åœæ­¢', description: 'ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨åœæ­¢ä¾¦å¬å™¨' },
          { name: 'æ‰‹åŠ¨åœæ­¢', description: 'è°ƒç”¨è¿”å›çš„åœæ­¢å‡½æ•°æ‰‹åŠ¨åœæ­¢' },
          { name: 'æ¡ä»¶åœæ­¢', description: 'æ ¹æ®æ¡ä»¶åŠ¨æ€åœæ­¢ä¾¦å¬å™¨' }
        ]"
        :code-explanation="stopWatcherCodeExplanation"
        :notes="[
          'åœ¨setup()ä¸­åˆ›å»ºçš„ä¾¦å¬å™¨ä¼šåœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨åœæ­¢',
          'åœ¨å¼‚æ­¥å›è°ƒä¸­åˆ›å»ºçš„ä¾¦å¬å™¨éœ€è¦æ‰‹åŠ¨åœæ­¢',
          'åŠæ—¶åœæ­¢ä¸éœ€è¦çš„ä¾¦å¬å™¨å¯ä»¥é¿å…å†…å­˜æ³„æ¼'
        ]"
      />

      <div class="demo-container">
        <DemoRunner :component="StopWatcherDemo" title="åœæ­¢ä¾¦å¬å™¨ç¤ºä¾‹" />
      </div>

      <CodeBlock
        :code="stopWatcherCode"
        language="javascript"
        title="åœæ­¢ä¾¦å¬å™¨ä»£ç "
      />
    </section>
  </div>
</template>

<script>
import { defineComponent, ref, reactive, watch, watchEffect, nextTick, computed } from 'vue'
import CommentBox from '@/components/CodeDemo/CommentBox.vue'
import DemoRunner from '@/components/CodeDemo/DemoRunner.vue'
import CodeBlock from '@/components/CodeDemo/CodeBlock.vue'

// åŸºç¡€ä¾¦å¬å™¨ç¤ºä¾‹ç»„ä»¶
const BasicWatchDemo = defineComponent({
  setup() {
    // å“åº”å¼æ•°æ®å®šä¹‰
    const count = ref(0)           // è®¡æ•°å™¨ï¼Œç”¨äºæ¼”ç¤ºæ•°å­—ç±»å‹çš„ä¾¦å¬
    const message = ref('Hello')   // æ¶ˆæ¯æ–‡æœ¬ï¼Œç”¨äºæ¼”ç¤ºå­—ç¬¦ä¸²ç±»å‹çš„ä¾¦å¬
    const logs = ref([])          // æ—¥å¿—æ•°ç»„ï¼Œè®°å½•ä¾¦å¬å™¨è§¦å‘çš„å†å²

    // ä¾¦å¬å•ä¸ªref - åŸºç¡€ç”¨æ³•
    // å½“countå€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨
    // å›è°ƒå‡½æ•°æ¥æ”¶æ–°å€¼(newVal)å’Œæ—§å€¼(oldVal)ä½œä¸ºå‚æ•°
    watch(count, (newVal, oldVal) => {
      logs.value.push(`countå˜åŒ–: ${oldVal} -> ${newVal}`)
    })

    // ä¾¦å¬å¤šä¸ªæ•°æ®æº - é«˜çº§ç”¨æ³•
    // å¯ä»¥åŒæ—¶ä¾¦å¬å¤šä¸ªå“åº”å¼æ•°æ®ï¼Œä»»ä¸€æ•°æ®å˜åŒ–éƒ½ä¼šè§¦å‘å›è°ƒ
    // å›è°ƒå‡½æ•°æ¥æ”¶æ–°å€¼æ•°ç»„å’Œæ—§å€¼æ•°ç»„ä½œä¸ºå‚æ•°
    watch([count, message], ([newCount, newMessage], [oldCount, oldMessage]) => {
      logs.value.push(`å¤šæºä¾¦å¬: count(${oldCount}->${newCount}), message(${oldMessage}->${newMessage})`)
    })

    // æ“ä½œæ–¹æ³•å®šä¹‰
    function increment() {
      // å¢åŠ è®¡æ•°å™¨çš„å€¼ï¼Œè§¦å‘countçš„ä¾¦å¬å™¨
      count.value++
    }

    function updateMessage() {
      // å¾ªç¯æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼Œè§¦å‘messageçš„ä¾¦å¬å™¨
      const messages = ['Hello', 'Hi', 'Hey', 'Greetings']
      const current = messages.indexOf(message.value)
      message.value = messages[(current + 1) % messages.length]
    }

    function clearLogs() {
      // æ¸…ç©ºæ—¥å¿—æ•°ç»„ï¼Œé‡ç½®æ¼”ç¤ºçŠ¶æ€
      logs.value = []
    }

    return {
      count,
      message,
      logs,
      increment,
      updateMessage,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>åŸºç¡€ä¾¦å¬å™¨ç¤ºä¾‹</h3>
      <div style="margin: 1rem 0;">
        <p><strong>è®¡æ•°:</strong> {{ count }}</p>
        <p><strong>æ¶ˆæ¯:</strong> {{ message }}</p>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="increment">å¢åŠ è®¡æ•°</button>
        <button @click="updateMessage">æ›´æ”¹æ¶ˆæ¯</button>
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>ä¾¦å¬å™¨æ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
    </div>
  `
})

// ä¾¦å¬æ•°æ®æºç±»å‹ç¤ºä¾‹ç»„ä»¶
const WatchSourcesDemo = defineComponent({
  setup() {
    // refç±»å‹çš„å“åº”å¼æ•°æ®
    const refValue = ref(10)      // ç®€å•çš„refå€¼ï¼Œå¯ä»¥ç›´æ¥ä¾¦å¬
    
    // reactiveç±»å‹çš„å“åº”å¼æ•°æ®
    const state = reactive({
      name: 'å¼ ä¸‰',              // åŸºæœ¬å±æ€§
      age: 25,                  // æ•°å­—å±æ€§
      address: {                // åµŒå¥—å¯¹è±¡
        city: 'åŒ—äº¬',
        district: 'æœé˜³åŒº'
      }
    })
    
    const logs = ref([])         // æ—¥å¿—è®°å½•æ•°ç»„

    // ä¾¦å¬refç±»å‹æ•°æ® - ç›´æ¥ä¾¦å¬
    // refå¯ä»¥ç›´æ¥ä½œä¸ºä¾¦å¬æºï¼Œæ— éœ€ä½¿ç”¨getterå‡½æ•°
    watch(refValue, (newVal, oldVal) => {
      logs.value.push(`refä¾¦å¬: ${oldVal} -> ${newVal}`)
    })

    // ä¾¦å¬reactiveå¯¹è±¡çš„å±æ€§ - ä½¿ç”¨getterå‡½æ•°
    // reactiveå¯¹è±¡çš„å±æ€§éœ€è¦é€šè¿‡getterå‡½æ•°æ¥ä¾¦å¬
    watch(() => state.name, (newVal, oldVal) => {
      logs.value.push(`nameä¾¦å¬: ${oldVal} -> ${newVal}`)
    })

    // ä¾¦å¬åµŒå¥—å±æ€§ - æ·±å±‚å±æ€§è®¿é—®
    // å¯ä»¥ä¾¦å¬å¯¹è±¡å†…éƒ¨çš„åµŒå¥—å±æ€§
    watch(() => state.address.city, (newVal, oldVal) => {
      logs.value.push(`cityä¾¦å¬: ${oldVal} -> ${newVal}`)
    })

    // ä¾¦å¬å¤šä¸ªå±æ€§ - æ•°ç»„å½¢å¼çš„æ•°æ®æº
    // å¯ä»¥åŒæ—¶ä¾¦å¬å¤šä¸ªä¸åŒç±»å‹çš„æ•°æ®æº
    watch([() => state.name, () => state.age], ([newName, newAge], [oldName, oldAge]) => {
      logs.value.push(`å¤šå±æ€§ä¾¦å¬: name(${oldName}->${newName}), age(${oldAge}->${newAge})`)
    })

    function updateRefValue() {
      refValue.value = Math.floor(Math.random() * 100)
    }

    function updateName() {
      const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­']
      const current = names.indexOf(state.name)
      state.name = names[(current + 1) % names.length]
    }

    function updateAge() {
      state.age = Math.floor(Math.random() * 30) + 20
    }

    function updateCity() {
      const cities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³']
      const current = cities.indexOf(state.address.city)
      state.address.city = cities[(current + 1) % cities.length]
    }

    function clearLogs() {
      logs.value = []
    }

    return {
      refValue,
      state,
      logs,
      updateRefValue,
      updateName,
      updateAge,
      updateCity,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>ä¾¦å¬æ•°æ®æºç±»å‹ç¤ºä¾‹</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
        <div>
          <h4>Refæ•°æ®:</h4>
          <p>å€¼: {{ refValue }}</p>
          <button @click="updateRefValue">æ›´æ–°Refå€¼</button>
        </div>
        <div>
          <h4>Reactiveæ•°æ®:</h4>
          <p>å§“å: {{ state.name }}</p>
          <p>å¹´é¾„: {{ state.age }}</p>
          <p>åŸå¸‚: {{ state.address.city }}</p>
          <div>
            <button @click="updateName">æ›´æ–°å§“å</button>
            <button @click="updateAge">æ›´æ–°å¹´é¾„</button>
            <button @click="updateCity">æ›´æ–°åŸå¸‚</button>
          </div>
        </div>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>ä¾¦å¬å™¨æ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
    </div>
  `
})

// æ·±åº¦ä¾¦å¬ç¤ºä¾‹ç»„ä»¶
const DeepWatchDemo = defineComponent({
  setup() {
    // åˆ›å»ºå¤æ‚çš„åµŒå¥—å¯¹è±¡ç”¨äºæ¼”ç¤ºæ·±åº¦ä¾¦å¬
    const user = reactive({
      profile: {
        name: 'å¼ ä¸‰',              // ç”¨æˆ·å§“å
        contact: {
          email: 'zhangsan@example.com',  // é‚®ç®±åœ°å€
          phone: '138-0000-0000'          // ç”µè¯å·ç 
        }
      },
      preferences: {
        theme: 'light',            // ä¸»é¢˜è®¾ç½®
        language: 'zh-CN'          // è¯­è¨€è®¾ç½®
      }
    })
    
    const logs = ref([])          // æ—¥å¿—è®°å½•æ•°ç»„

    // æµ…å±‚ä¾¦å¬ - åªä¾¦å¬å¯¹è±¡å¼•ç”¨å˜åŒ–
    // åªæœ‰å½“user.profileè¢«é‡æ–°èµ‹å€¼æ—¶æ‰ä¼šè§¦å‘
    watch(() => user.profile, (newVal, oldVal) => {
      logs.value.push('profileå¯¹è±¡å¼•ç”¨å˜åŒ–ï¼ˆæµ…å±‚ä¾¦å¬ï¼‰')
    })

    // æ·±åº¦ä¾¦å¬ - ä¾¦å¬å¯¹è±¡å†…éƒ¨æ‰€æœ‰å±æ€§å˜åŒ–
    // å¼€å¯deepé€‰é¡¹åï¼Œå¯¹è±¡å†…éƒ¨ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘
    watch(() => user.profile, (newVal, oldVal) => {
      logs.value.push('profileå†…éƒ¨å±æ€§å˜åŒ–ï¼ˆæ·±åº¦ä¾¦å¬ï¼‰')
    }, { deep: true })

    // ä¾¦å¬ç‰¹å®šåµŒå¥—å±æ€§ï¼ˆæ¨èæ–¹å¼ï¼‰
    // ç›´æ¥ä¾¦å¬å…·ä½“çš„å±æ€§ï¼Œæ€§èƒ½æ›´å¥½ï¼Œæ›´ç²¾ç¡®
    watch(() => user.profile.contact.email, (newVal, oldVal) => {
      logs.value.push(`emailå˜åŒ–: ${oldVal} -> ${newVal}`)
    })

    // ä¾¦å¬æ•´ä¸ªå¯¹è±¡çš„æ·±åº¦å˜åŒ–
    // ä¾¦å¬userå¯¹è±¡çš„ä»»ä½•æ·±å±‚å±æ€§å˜åŒ–
    watch(user, (newVal, oldVal) => {
      logs.value.push('userå¯¹è±¡æ·±åº¦å˜åŒ–')
    }, { deep: true })

    function updateName() {
      const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­']
      const current = names.indexOf(user.profile.name)
      user.profile.name = names[(current + 1) % names.length]
    }

    function updateEmail() {
      const emails = ['zhangsan@example.com', 'lisi@example.com', 'wangwu@example.com']
      const current = emails.indexOf(user.profile.contact.email)
      user.profile.contact.email = emails[(current + 1) % emails.length]
    }

    function updateTheme() {
      user.preferences.theme = user.preferences.theme === 'light' ? 'dark' : 'light'
    }

    function clearLogs() {
      logs.value = []
    }

    return {
      user,
      logs,
      updateName,
      updateEmail,
      updateTheme,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>æ·±åº¦ä¾¦å¬ç¤ºä¾‹</h3>
      <div style="margin: 1rem 0;">
        <h4>ç”¨æˆ·ä¿¡æ¯:</h4>
        <p><strong>å§“å:</strong> {{ user.profile.name }}</p>
        <p><strong>é‚®ç®±:</strong> {{ user.profile.contact.email }}</p>
        <p><strong>ä¸»é¢˜:</strong> {{ user.preferences.theme }}</p>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="updateName">æ›´æ–°å§“å</button>
        <button @click="updateEmail">æ›´æ–°é‚®ç®±</button>
        <button @click="updateTheme">åˆ‡æ¢ä¸»é¢˜</button>
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>ä¾¦å¬å™¨æ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
        ğŸ’¡ è§‚å¯Ÿä¸åŒä¾¦å¬æ–¹å¼çš„è§¦å‘æƒ…å†µ
      </p>
    </div>
  `
})

// watchEffectç¤ºä¾‹ç»„ä»¶
const WatchEffectDemo = defineComponent({
  setup() {
    // å“åº”å¼æ•°æ®å®šä¹‰
    const count = ref(0)          // è®¡æ•°å™¨
    const name = ref('å¼ ä¸‰')       // å§“å
    const enabled = ref(true)     // å¯ç”¨çŠ¶æ€
    const logs = ref([])         // æ—¥å¿—è®°å½•

    // åŸºç¡€watchEffect - è‡ªåŠ¨è¿½è¸ªä¾èµ–
    // watchEffectä¼šè‡ªåŠ¨è¿½è¸ªå‡½æ•°å†…ä½¿ç”¨çš„æ‰€æœ‰å“åº”å¼æ•°æ®
    // æ— éœ€æ‰‹åŠ¨æŒ‡å®šä¾èµ–ï¼Œä»»ä½•ä¾èµ–å˜åŒ–éƒ½ä¼šé‡æ–°æ‰§è¡Œ
    watchEffect(() => {
      logs.value.push(`watchEffectæ‰§è¡Œ: count=${count.value}, name=${name.value}`)
    })

    // æ¡ä»¶æ€§watchEffect
    // å¯ä»¥åœ¨watchEffectå†…éƒ¨ä½¿ç”¨æ¡ä»¶é€»è¾‘
    watchEffect(() => {
      if (enabled.value) {
        logs.value.push(`æ¡ä»¶watchEffect: å½“å‰è®¡æ•°=${count.value}`)
      }
      // è¿½è¸ªenabledå’Œcountä¸¤ä¸ªä¾èµ–
      // enabledä¸ºfalseæ—¶ä¸ä¼šè¾“å‡ºï¼Œä½†ä»ä¼šè¿½è¸ªcountçš„å˜åŒ–
    })

    // å¸¦æ¸…ç†å‡½æ•°çš„watchEffect
    // ç”¨äºæ¸…ç†å‰¯ä½œç”¨ï¼Œå¦‚å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨ç­‰
    let timerId = 0
    watchEffect((onCleanup) => {
      const timer = setTimeout(() => {
        logs.value.push(`å®šæ—¶å™¨${++timerId}æ‰§è¡Œ`)
      }, 1000)
      
      // æ¸…ç†å‡½æ•°ï¼šåœ¨é‡æ–°æ‰§è¡Œå‰æˆ–ç»„ä»¶å¸è½½æ—¶è°ƒç”¨
      onCleanup(() => {
        clearTimeout(timer)
        logs.value.push(`æ¸…ç†å®šæ—¶å™¨${timerId}`)
      })
    })

    // å¯åœæ­¢çš„watchEffect
    // watchEffectè¿”å›ä¸€ä¸ªåœæ­¢å‡½æ•°ï¼Œå¯ä»¥æ‰‹åŠ¨åœæ­¢ä¾¦å¬
    const stopEffect = watchEffect(() => {
      if (count.value > 5) {
        logs.value.push('è®¡æ•°è¶…è¿‡5ï¼Œå‡†å¤‡åœæ­¢watchEffect')
        // å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨stopEffect()æ¥åœæ­¢è‡ªå·±
      }
    })

    function increment() {
      count.value++
    }

    function updateName() {
      const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­']
      const current = names.indexOf(name.value)
      name.value = names[(current + 1) % names.length]
    }

    function toggleEnabled() {
      enabled.value = !enabled.value
    }

    function stopWatchEffect() {
      stopEffect()
      logs.value.push('æ‰‹åŠ¨åœæ­¢watchEffect')
    }

    function clearLogs() {
      logs.value = []
    }

    return {
      count,
      name,
      enabled,
      logs,
      increment,
      updateName,
      toggleEnabled,
      stopWatchEffect,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>watchEffectç¤ºä¾‹</h3>
      <div style="margin: 1rem 0;">
        <p><strong>è®¡æ•°:</strong> {{ count }}</p>
        <p><strong>å§“å:</strong> {{ name }}</p>
        <p><strong>å¯ç”¨çŠ¶æ€:</strong> {{ enabled ? 'å¯ç”¨' : 'ç¦ç”¨' }}</p>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="increment">å¢åŠ è®¡æ•°</button>
        <button @click="updateName">æ›´æ”¹å§“å</button>
        <button @click="toggleEnabled">åˆ‡æ¢å¯ç”¨çŠ¶æ€</button>
        <button @click="stopWatchEffect">åœæ­¢watchEffect</button>
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>watchEffectæ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
        ğŸ’¡ watchEffectä¼šç«‹å³æ‰§è¡Œå¹¶è‡ªåŠ¨è¿½è¸ªä¾èµ–
      </p>
    </div>
  `
})

// ä¾¦å¬å™¨é€‰é¡¹ç¤ºä¾‹ç»„ä»¶
const WatchOptionsDemo = defineComponent({
  setup() {
    // å“åº”å¼æ•°æ®å®šä¹‰
    const count = ref(0)         // è®¡æ•°å™¨
    const user = reactive({      // ç”¨æˆ·å¯¹è±¡
      name: 'å¼ ä¸‰',
      profile: {
        age: 25,
        city: 'åŒ—äº¬'
      }
    })
    const logs = ref([])        // æ—¥å¿—è®°å½•

    // 1. immediateé€‰é¡¹ - ç«‹å³æ‰§è¡Œ
    // è®¾ç½®immediate: trueä½¿ä¾¦å¬å™¨åœ¨åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
    watch(count, (newVal, oldVal) => {
      logs.value.push(`immediateä¾¦å¬: ${oldVal} -> ${newVal}`)
    }, { immediate: true })  // åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œ

    // 2. deepé€‰é¡¹ - æ·±åº¦ä¾¦å¬
    // å¼€å¯deepé€‰é¡¹æ¥ä¾¦å¬å¯¹è±¡å†…éƒ¨å±æ€§çš„å˜åŒ–
    watch(() => user, (newVal, oldVal) => {
      logs.value.push('deepä¾¦å¬: userå¯¹è±¡å†…éƒ¨å˜åŒ–')
    }, { deep: true })  // æ·±åº¦ä¾¦å¬å¯¹è±¡å†…éƒ¨å˜åŒ–

    // 3. flushé€‰é¡¹ - æ§åˆ¶å›è°ƒæ‰§è¡Œæ—¶æœº
    // flush: 'post' è¡¨ç¤ºåœ¨DOMæ›´æ–°åæ‰§è¡Œå›è°ƒ
    watch(count, (newVal, oldVal) => {
      logs.value.push(`post flush: ${oldVal} -> ${newVal} (DOMæ›´æ–°å)`)
    }, { flush: 'post' })  // DOMæ›´æ–°åæ‰§è¡Œ

    // 4. è°ƒè¯•é€‰é¡¹ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    // onTrackå’ŒonTriggerç”¨äºè°ƒè¯•ä¾¦å¬å™¨çš„ä¾èµ–è¿½è¸ªè¿‡ç¨‹
    watch(count, (newVal, oldVal) => {
      logs.value.push(`è°ƒè¯•ä¾¦å¬: ${oldVal} -> ${newVal}`)
    }, {
      onTrack(e) {
        console.log('è¿½è¸ªåˆ°ä¾èµ–:', e)
        logs.value.push('è¿½è¸ªåˆ°ä¾èµ–å˜åŒ–')
      },
      onTrigger(e) {
        console.log('ä¾èµ–è§¦å‘:', e)
        logs.value.push('ä¾èµ–è§¦å‘ä¾¦å¬å™¨')
      }
    })

    function increment() {
      count.value++
    }

    function updateUser() {
      user.name = user.name === 'å¼ ä¸‰' ? 'æå››' : 'å¼ ä¸‰'
      user.profile.age = Math.floor(Math.random() * 30) + 20
    }

    function clearLogs() {
      logs.value = []
    }

    return {
      count,
      user,
      logs,
      increment,
      updateUser,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>ä¾¦å¬å™¨é€‰é¡¹ç¤ºä¾‹</h3>
      <div style="margin: 1rem 0;">
        <p><strong>è®¡æ•°:</strong> {{ count }}</p>
        <p><strong>ç”¨æˆ·:</strong> {{ user.name }}, {{ user.profile.age }}å²</p>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="increment">å¢åŠ è®¡æ•°</button>
        <button @click="updateUser">æ›´æ–°ç”¨æˆ·</button>
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>ä¾¦å¬å™¨æ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
        ğŸ’¡ è§‚å¯Ÿä¸åŒé€‰é¡¹å¯¹ä¾¦å¬å™¨è¡Œä¸ºçš„å½±å“
      </p>
    </div>
  `
})

// åœæ­¢ä¾¦å¬å™¨ç¤ºä¾‹ç»„ä»¶
const StopWatcherDemo = defineComponent({
  setup() {
    // å“åº”å¼æ•°æ®å®šä¹‰
    const count = ref(0)         // è®¡æ•°å™¨
    const logs = ref([])        // æ—¥å¿—è®°å½•
    let watchStopped = false    // æ ‡è®°ä¾¦å¬å™¨æ˜¯å¦å·²åœæ­¢
    let effectStopped = false   // æ ‡è®°watchEffectæ˜¯å¦å·²åœæ­¢

    // watchè¿”å›åœæ­¢å‡½æ•°
    // å¯ä»¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥æ‰‹åŠ¨åœæ­¢ä¾¦å¬å™¨
    const stopWatch = watch(count, (newVal, oldVal) => {
      if (!watchStopped) {
        logs.value.push(`watchä¾¦å¬: ${oldVal} -> ${newVal}`)
        // å½“è®¡æ•°è¾¾åˆ°10æ—¶è‡ªåŠ¨åœæ­¢
        if (newVal >= 10) {
          logs.value.push('è®¡æ•°è¾¾åˆ°10ï¼Œè‡ªåŠ¨åœæ­¢watch')
          stopWatch()
          watchStopped = true
        }
      }
    })

    // watchEffectä¹Ÿè¿”å›åœæ­¢å‡½æ•°
    // åŒæ ·å¯ä»¥æ‰‹åŠ¨åœæ­¢watchEffect
    const stopEffect = watchEffect(() => {
      if (!effectStopped) {
        logs.value.push(`watchEffectæ‰§è¡Œ: å½“å‰è®¡æ•°=${count.value}`)
      }
    })

    function increment() {
      count.value++
    }

    function stopWatchManually() {
      if (!watchStopped) {
        stopWatch()
        watchStopped = true
        logs.value.push('æ‰‹åŠ¨åœæ­¢watchä¾¦å¬å™¨')
      }
    }

    function stopEffectManually() {
      if (!effectStopped) {
        stopEffect()
        effectStopped = true
        logs.value.push('æ‰‹åŠ¨åœæ­¢watchEffect')
      }
    }

    function clearLogs() {
      logs.value = []
    }

    return {
      count,
      logs,
      increment,
      stopWatchManually,
      stopEffectManually,
      clearLogs
    }
  },
  template: `
    <div class="demo-item">
      <h3>åœæ­¢ä¾¦å¬å™¨ç¤ºä¾‹</h3>
      <div style="margin: 1rem 0;">
        <p><strong>è®¡æ•°:</strong> {{ count }}</p>
      </div>
      <div style="margin: 1rem 0;">
        <button @click="increment">å¢åŠ è®¡æ•°</button>
        <button @click="stopWatchManually">åœæ­¢Watch</button>
        <button @click="stopEffectManually">åœæ­¢WatchEffect</button>
        <button @click="clearLogs">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div style="margin: 1rem 0;">
        <h4>æ—¥å¿—:</h4>
        <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          <div v-if="logs.length === 0" style="color: #666; font-style: italic;">æš‚æ— æ—¥å¿—</div>
          <div v-for="(log, index) in logs" :key="index" style="margin: 0.25rem 0; font-family: monospace; font-size: 0.9rem;">
            {{ log }}
          </div>
        </div>
      </div>
      <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
        ğŸ’¡ è®¡æ•°è¾¾åˆ°10æ—¶ä¼šè‡ªåŠ¨åœæ­¢ä¸€ä¸ªä¾¦å¬å™¨
      </p>
    </div>
  `
})

// ä»£ç ç¤ºä¾‹å­—ç¬¦ä¸²
const basicWatchCode = `// åŸºç¡€ä¾¦å¬å™¨ç”¨æ³•
import { ref, watch } from 'vue'

// åˆ›å»ºå“åº”å¼æ•°æ®
const count = ref(0)      // æ•°å­—ç±»å‹çš„ref
const message = ref('Hello')  // å­—ç¬¦ä¸²ç±»å‹çš„ref

// 1. ä¾¦å¬å•ä¸ªref
// watch(æ•°æ®æº, å›è°ƒå‡½æ•°)
// å›è°ƒå‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šæ–°å€¼å’Œæ—§å€¼
watch(count, (newVal, oldVal) => {
  console.log(\`countå˜åŒ–: \${oldVal} -> \${newVal}\`)
  // å½“count.valueå‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨
})

// 2. ä¾¦å¬å¤šä¸ªæ•°æ®æº
// ä½¿ç”¨æ•°ç»„å½¢å¼åŒæ—¶ä¾¦å¬å¤šä¸ªå“åº”å¼æ•°æ®
// å›è°ƒå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯æ•°ç»„å½¢å¼ï¼Œå¯¹åº”å„ä¸ªæ•°æ®æºçš„æ–°å€¼å’Œæ—§å€¼
watch([count, message], ([newCount, newMessage], [oldCount, oldMessage]) => {
  console.log('å¤šä¸ªæ•°æ®æºå˜åŒ–')
  console.log(\`count: \${oldCount} -> \${newCount}\`)
  console.log(\`message: \${oldMessage} -> \${newMessage}\`)
  // ä»»ä½•ä¸€ä¸ªæ•°æ®æºå˜åŒ–éƒ½ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ
})

// 3. ä¾¦å¬getterå‡½æ•°
// å¯ä»¥ä¾¦å¬ä¸€ä¸ªè®¡ç®—è¡¨è¾¾å¼çš„ç»“æœ
// å½“è¡¨è¾¾å¼ä¾èµ–çš„å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œä¼šé‡æ–°è®¡ç®—å¹¶è§¦å‘å›è°ƒ
watch(
  () => count.value * 2,  // getterå‡½æ•°ï¼Œè¿”å›countçš„ä¸¤å€
  (newVal, oldVal) => {
    console.log(\`è®¡ç®—å€¼å˜åŒ–: \${oldVal} -> \${newVal}\`)
    // å½“countå˜åŒ–å¯¼è‡´è®¡ç®—ç»“æœå˜åŒ–æ—¶è§¦å‘
  }
)`

const watchSourcesCode = `// ä¾¦å¬ä¸åŒç±»å‹çš„æ•°æ®æº
import { ref, reactive, watch } from 'vue'

// åˆ›å»ºä¸åŒç±»å‹çš„å“åº”å¼æ•°æ®
const refValue = ref(10)  // refç±»å‹çš„å“åº”å¼æ•°æ®
const state = reactive({  // reactiveç±»å‹çš„å“åº”å¼å¯¹è±¡
  name: 'å¼ ä¸‰',
  age: 25,
  address: {
    city: 'åŒ—äº¬',
    district: 'æœé˜³åŒº'
  }
})

// 1. ä¾¦å¬ref
// ç›´æ¥ä¾¦å¬refç±»å‹çš„æ•°æ®ï¼ŒVueä¼šè‡ªåŠ¨è§£åŒ….value
watch(refValue, (newVal, oldVal) => {
  console.log(\`refå€¼å˜åŒ–: \${oldVal} -> \${newVal}\`)
  // refValue.valueå˜åŒ–æ—¶è§¦å‘
})

// 2. ä¾¦å¬reactiveå¯¹è±¡çš„å±æ€§ï¼ˆä½¿ç”¨getterï¼‰
// å¯¹äºreactiveå¯¹è±¡çš„å±æ€§ï¼Œéœ€è¦ä½¿ç”¨getterå‡½æ•°
watch(() => state.name, (newVal, oldVal) => {
  console.log(\`nameå˜åŒ–: \${oldVal} -> \${newVal}\`)
  // state.nameå˜åŒ–æ—¶è§¦å‘
})

// 3. ä¾¦å¬åµŒå¥—å±æ€§
// å¯ä»¥ä¾¦å¬å¯¹è±¡æ·±å±‚åµŒå¥—çš„å±æ€§
watch(() => state.address.city, (newVal, oldVal) => {
  console.log(\`cityå˜åŒ–: \${oldVal} -> \${newVal}\`)
  // state.address.cityå˜åŒ–æ—¶è§¦å‘
})

// 4. ä¾¦å¬å¤šä¸ªå±æ€§
// ä½¿ç”¨æ•°ç»„åŒæ—¶ä¾¦å¬å¤šä¸ªreactiveå¯¹è±¡çš„å±æ€§
watch(
  [() => state.name, () => state.age],  // å¤šä¸ªgetterå‡½æ•°
  ([newName, newAge], [oldName, oldAge]) => {
    console.log(\`name: \${oldName} -> \${newName}\`)
    console.log(\`age: \${oldAge} -> \${newAge}\`)
    // ä»»ä½•ä¸€ä¸ªå±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘
  }
)

// 5. ä¾¦å¬æ•´ä¸ªreactiveå¯¹è±¡ï¼ˆæ·±åº¦ä¾¦å¬ï¼‰
// ä¾¦å¬æ•´ä¸ªå¯¹è±¡çš„ä»»ä½•å±æ€§å˜åŒ–ï¼Œéœ€è¦å¼€å¯deepé€‰é¡¹
watch(state, (newVal, oldVal) => {
  console.log('stateå¯¹è±¡å‘ç”Ÿå˜åŒ–')
  // å¯¹è±¡å†…ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘ï¼ˆåŒ…æ‹¬åµŒå¥—å±æ€§ï¼‰
}, { deep: true })  // å¼€å¯æ·±åº¦ä¾¦å¬`

const deepWatchCode = `// æ·±åº¦ä¾¦å¬ç¤ºä¾‹
import { reactive, watch } from 'vue'

// åˆ›å»ºä¸€ä¸ªå¤æ‚çš„åµŒå¥—å¯¹è±¡
const user = reactive({
  profile: {
    name: 'å¼ ä¸‰',
    contact: {
      email: 'zhangsan@example.com',
      phone: '138-0000-0000'
    }
  },
  preferences: {
    theme: 'light',
    language: 'zh-CN'
  }
})

// 1. æµ…å±‚ä¾¦å¬ - åªä¾¦å¬å¯¹è±¡å¼•ç”¨å˜åŒ–
// åªæœ‰å½“user.profileè¢«é‡æ–°èµ‹å€¼æ—¶æ‰ä¼šè§¦å‘
watch(() => user.profile, (newVal, oldVal) => {
  console.log('profileå¯¹è±¡å¼•ç”¨å˜åŒ–')
  // ä¿®æ”¹user.profile.nameä¸ä¼šè§¦å‘è¿™ä¸ªä¾¦å¬å™¨
})

// 2. æ·±åº¦ä¾¦å¬ - ä¾¦å¬å¯¹è±¡å†…éƒ¨æ‰€æœ‰å±æ€§å˜åŒ–
// å¼€å¯deepé€‰é¡¹åï¼Œå¯¹è±¡å†…éƒ¨ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘
watch(() => user.profile, (newVal, oldVal) => {
  console.log('profileå†…éƒ¨å±æ€§å˜åŒ–')
  // ä¿®æ”¹user.profile.nameæˆ–user.profile.contact.emailéƒ½ä¼šè§¦å‘
}, { deep: true })

// 3. ä¾¦å¬ç‰¹å®šåµŒå¥—å±æ€§ï¼ˆæ¨èæ–¹å¼ï¼‰
// ç›´æ¥ä¾¦å¬å…·ä½“çš„å±æ€§ï¼Œæ€§èƒ½æ›´å¥½ï¼Œæ›´ç²¾ç¡®
watch(() => user.profile.contact.email, (newVal, oldVal) => {
  console.log(\`emailå˜åŒ–: \${oldVal} -> \${newVal}\`)
  // åªæœ‰emailå˜åŒ–æ—¶æ‰è§¦å‘ï¼Œæ€§èƒ½æœ€ä¼˜
})

// 4. ä¾¦å¬æ•´ä¸ªå¯¹è±¡çš„æ·±åº¦å˜åŒ–
// ä¾¦å¬userå¯¹è±¡çš„ä»»ä½•æ·±å±‚å±æ€§å˜åŒ–
watch(user, (newVal, oldVal) => {
  console.log('userå¯¹è±¡æ·±åº¦å˜åŒ–')
  // userå¯¹è±¡å†…ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘ï¼ˆåŒ…æ‹¬æ‰€æœ‰åµŒå¥—å±æ€§ï¼‰
}, { deep: true })  // å¿…é¡»å¼€å¯deepé€‰é¡¹`

const watchEffectCode = `// watchEffectç”¨æ³•
import { ref, watchEffect } from 'vue'

// åˆ›å»ºå“åº”å¼æ•°æ®
const count = ref(0)
const name = ref('å¼ ä¸‰')
const enabled = ref(true)

// 1. åŸºç¡€watchEffect - è‡ªåŠ¨è¿½è¸ªä¾èµ–
// watchEffectä¼šè‡ªåŠ¨è¿½è¸ªå‡½æ•°å†…ä½¿ç”¨çš„æ‰€æœ‰å“åº”å¼æ•°æ®
// æ— éœ€æ‰‹åŠ¨æŒ‡å®šä¾èµ–ï¼Œä»»ä½•ä¾èµ–å˜åŒ–éƒ½ä¼šé‡æ–°æ‰§è¡Œ
watchEffect(() => {
  console.log(\`count: \${count.value}, name: \${name.value}\`)
  // è‡ªåŠ¨è¿½è¸ªcountå’Œnameçš„å˜åŒ–
  // å½“countæˆ–nameä»»ä¸€å˜åŒ–æ—¶ï¼Œè¿™ä¸ªå‡½æ•°éƒ½ä¼šé‡æ–°æ‰§è¡Œ
})

// 2. æ¡ä»¶æ€§watchEffect
// å¯ä»¥åœ¨watchEffectå†…éƒ¨ä½¿ç”¨æ¡ä»¶é€»è¾‘
watchEffect(() => {
  if (enabled.value) {
    console.log(\`å½“å‰è®¡æ•°: \${count.value}\`)
  }
  // è¿½è¸ªenabledå’Œcountä¸¤ä¸ªä¾èµ–
  // enabledä¸ºfalseæ—¶ä¸ä¼šè¾“å‡ºï¼Œä½†ä»ä¼šè¿½è¸ªcountçš„å˜åŒ–
})

// 3. å¸¦æ¸…ç†å‡½æ•°çš„watchEffect
// ç”¨äºæ¸…ç†å‰¯ä½œç”¨ï¼Œå¦‚å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨ç­‰
watchEffect((onCleanup) => {
  const timer = setTimeout(() => {
    console.log('å®šæ—¶å™¨æ‰§è¡Œ')
  }, 1000)
  
  // æ¸…ç†å‡½æ•°ï¼šåœ¨é‡æ–°æ‰§è¡Œå‰æˆ–ç»„ä»¶å¸è½½æ—¶è°ƒç”¨
  onCleanup(() => {
    clearTimeout(timer)
    console.log('æ¸…ç†å®šæ—¶å™¨')
    // ç¡®ä¿ä¸ä¼šæœ‰å†…å­˜æ³„æ¼
  })
})

// 4. å¯åœæ­¢çš„watchEffect
// watchEffectè¿”å›ä¸€ä¸ªåœæ­¢å‡½æ•°ï¼Œå¯ä»¥æ‰‹åŠ¨åœæ­¢ä¾¦å¬
const stop = watchEffect(() => {
  console.log(\`è®¡æ•°: \${count.value}\`)
})

// æ‰‹åŠ¨åœæ­¢
stop()`

const watchOptionsCode = `// ä¾¦å¬å™¨é€‰é¡¹
import { ref, reactive, watch } from 'vue'

const count = ref(0)
const user = reactive({ name: 'å¼ ä¸‰', age: 25 })

// 1. immediateé€‰é¡¹ - ç«‹å³æ‰§è¡Œ
// åˆ›å»ºä¾¦å¬å™¨æ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒ
watch(count, (newVal, oldVal) => {
  console.log(\`count: \${oldVal} -> \${newVal}\`)
}, { immediate: true })  // ç«‹å³æ‰§è¡Œ

// 2. deepé€‰é¡¹ - æ·±åº¦ä¾¦å¬
// ä¾¦å¬å¯¹è±¡å†…éƒ¨å±æ€§çš„å˜åŒ–
watch(user, (newVal, oldVal) => {
  console.log('userå¯¹è±¡å˜åŒ–')
}, { deep: true })  // æ·±åº¦ä¾¦å¬

// 3. flushé€‰é¡¹ - æ§åˆ¶æ‰§è¡Œæ—¶æœº
// 'pre': ç»„ä»¶æ›´æ–°å‰æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
// 'post': ç»„ä»¶æ›´æ–°åæ‰§è¡Œ
// 'sync': åŒæ­¥æ‰§è¡Œ
watch(count, (newVal, oldVal) => {
  console.log('DOMæ›´æ–°åæ‰§è¡Œ')
}, {
  flush: 'post'     // DOMæ›´æ–°åæ‰§è¡Œ
})

// 4. è°ƒè¯•é€‰é¡¹ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
// ç”¨äºè°ƒè¯•ä¾¦å¬å™¨çš„ä¾èµ–è¿½è¸ªå’Œè§¦å‘è¿‡ç¨‹
watch(count, (newVal, oldVal) => {
  console.log('countå˜åŒ–')
}, {
  onTrack(e) {
    console.log('è¿½è¸ªåˆ°ä¾èµ–:', e)
    // å½“ä¾¦å¬å™¨è¿½è¸ªåˆ°å“åº”å¼ä¾èµ–æ—¶è°ƒç”¨
  },
  onTrigger(e) {
    console.log('ä¾èµ–è§¦å‘:', e)
    // å½“ä¾èµ–å˜åŒ–è§¦å‘ä¾¦å¬å™¨æ—¶è°ƒç”¨
  }
})`

const stopWatcherCode = `// åœæ­¢ä¾¦å¬å™¨
import { ref, watch, watchEffect } from 'vue'

const count = ref(0)

// watchè¿”å›åœæ­¢å‡½æ•°
const stopWatch = watch(count, (newVal, oldVal) => {
  console.log(\`count: \${oldVal} -> \${newVal}\`)
})

// watchEffectä¹Ÿè¿”å›åœæ­¢å‡½æ•°
const stopEffect = watchEffect(() => {
  console.log(\`å½“å‰è®¡æ•°: \${count.value}\`)
})

// æ‰‹åŠ¨åœæ­¢ä¾¦å¬å™¨
function stopWatchers() {
  stopWatch()   // åœæ­¢watch
  stopEffect()  // åœæ­¢watchEffect
}

// æ¡ä»¶æ€§åœæ­¢
watch(count, (newVal) => {
  if (newVal >= 10) {
    console.log('è¾¾åˆ°ä¸Šé™ï¼Œåœæ­¢ä¾¦å¬')
    stopWatch() // åœ¨å›è°ƒä¸­åœæ­¢è‡ªå·±
  }
})

// è‡ªåŠ¨åœæ­¢çš„watchEffect
const autoStop = watchEffect(() => {
  if (count.value > 5) {
    console.log('è‡ªåŠ¨åœæ­¢')
    autoStop()
  }
})

// åœ¨ç»„ä»¶ä¸­ï¼Œsetup()å†…åˆ›å»ºçš„ä¾¦å¬å™¨ä¼šè‡ªåŠ¨åœæ­¢
// åœ¨å¼‚æ­¥å›è°ƒä¸­åˆ›å»ºçš„ä¾¦å¬å™¨éœ€è¦æ‰‹åŠ¨ç®¡ç†
setTimeout(() => {
  const asyncWatch = watch(count, callback)
  // éœ€è¦æ‰‹åŠ¨åœæ­¢asyncWatch
}, 1000)`

// ä¸»ç»„ä»¶å®šä¹‰
export default defineComponent({
  name: 'WatchersDemo',
  components: {
    CommentBox,
    DemoRunner,
    CodeBlock,
    BasicWatchDemo,
    WatchSourcesDemo,
    DeepWatchDemo,
    WatchEffectDemo,
    WatchOptionsDemo,
    StopWatcherDemo
  },
  setup() {
    // ä¸ºå†…è”code-explanationæ•°ç»„åˆ›å»ºè®¡ç®—å±æ€§
    const basicWatchCodeExplanation = computed(() => [
      { code: 'watch(source, callback)', explanation: 'åŸºç¡€ä¾¦å¬å™¨è¯­æ³•ï¼Œä¾¦å¬æ•°æ®æºå˜åŒ–' },
      { code: 'watch(count, (newVal, oldVal) => {})', explanation: 'ä¾¦å¬refï¼Œå›è°ƒæ¥æ”¶æ–°å€¼å’Œæ—§å€¼' },
      { code: 'watch(() => obj.prop, callback)', explanation: 'ä¾¦å¬å¯¹è±¡å±æ€§ï¼Œä½¿ç”¨getterå‡½æ•°' }
    ])

    const watchSourcesCodeExplanation = computed(() => [
      { code: 'watch(refValue, callback)', explanation: 'ä¾¦å¬refå€¼çš„å˜åŒ–' },
      { code: 'watch(() => state.prop, callback)', explanation: 'ä¾¦å¬reactiveå¯¹è±¡çš„å±æ€§' },
      { code: 'watch([source1, source2], callback)', explanation: 'ä¾¦å¬å¤šä¸ªæ•°æ®æº' }
    ])

    const deepWatchCodeExplanation = computed(() => [
      { code: 'watch(obj, callback, { deep: true })', explanation: 'å¯ç”¨æ·±åº¦ä¾¦å¬' },
      { code: 'watch(() => obj.nested.prop, callback)', explanation: 'ä¾¦å¬ç‰¹å®šåµŒå¥—å±æ€§' },
      { code: 'watchEffect(() => { console.log(obj.nested.prop) })', explanation: 'watchEffectè‡ªåŠ¨è¿½è¸ªä¾èµ–' }
    ])

    const watchEffectCodeExplanation = computed(() => [
      { code: 'watchEffect(() => { console.log(count.value) })', explanation: 'watchEffectè‡ªåŠ¨è¿½è¸ªcountä¾èµ–' },
      { code: 'const stop = watchEffect(callback)', explanation: 'è¿”å›åœæ­¢å‡½æ•°ï¼Œå¯æ‰‹åŠ¨åœæ­¢ä¾¦å¬' },
      { code: 'watchEffect((onCleanup) => { onCleanup(() => {}) })', explanation: 'ä½¿ç”¨æ¸…ç†å‡½æ•°' }
    ])

    const watchOptionsCodeExplanation = computed(() => [
      { code: 'watch(source, callback, { immediate: true })', explanation: 'åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œå›è°ƒ' },
      { code: 'watch(source, callback, { deep: true })', explanation: 'å¯ç”¨æ·±åº¦ä¾¦å¬' },
      { code: 'watch(source, callback, { flush: \'post\' })', explanation: 'åœ¨DOMæ›´æ–°åæ‰§è¡Œå›è°ƒ' }
    ])

    const stopWatcherCodeExplanation = computed(() => [
      { code: 'const stop = watch(source, callback)', explanation: 'watchè¿”å›åœæ­¢å‡½æ•°' },
      { code: 'stop()', explanation: 'è°ƒç”¨åœæ­¢å‡½æ•°åœæ­¢ä¾¦å¬' },
      { code: 'if (condition) stop()', explanation: 'æ¡ä»¶æ€§åœæ­¢ä¾¦å¬å™¨' }
    ])

    return {
      // ä»£ç ç¤ºä¾‹
      basicWatchCode,
      watchSourcesCode,
      deepWatchCode,
      watchEffectCode,
      watchOptionsCode,
      stopWatcherCode,
      // è®¡ç®—å±æ€§
      basicWatchCodeExplanation,
      watchSourcesCodeExplanation,
      deepWatchCodeExplanation,
      watchEffectCodeExplanation,
      watchOptionsCodeExplanation,
      stopWatcherCodeExplanation
    }
  }
})
</script>

<style scoped>
.watchers-demo {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.page-header {
  text-align: center;
  margin-bottom: 3rem;
  padding: 2rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
}

.page-header h1 {
  font-size: 2.5rem;
  margin-bottom: 1rem;
  font-weight: 700;
}

.page-description {
  font-size: 1.1rem;
  opacity: 0.9;
  max-width: 600px;
  margin: 0 auto;
  line-height: 1.6;
}

.demo-section {
  margin-bottom: 4rem;
}

.demo-section h2 {
  color: #2c3e50;
  font-size: 1.8rem;
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 3px solid #4FC08D;
  display: inline-block;
}

.demo-container {
  margin: 2rem 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .watchers-demo {
    padding: 1rem;
  }
  
  .page-header {
    padding: 1.5rem;
  }
  
  .page-header h1 {
    font-size: 2rem;
  }
  
  .demo-section h2 {
    font-size: 1.5rem;
  }
}
</style>